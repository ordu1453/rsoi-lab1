name: CI/CD Flask App

on:
  push:
    branches:
      - main
      - master
      - dev

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      # Клонируем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v4

      # Устанавливаем Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      # Устанавливаем зависимости
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Запускаем unit-тесты
      - name: Run tests
        run: |
          python -m unittest discover -p "test_*.py" -v

      # Собираем Docker-образ
      - name: Build Docker image
        run: docker build -t rsoi-lab1:latest .

      # Деплой на Render
      - name: Deploy to Render
        uses: JorgeLNJunior/render-deploy@v1.4.5
        with: |
          service_id: ${{ secrets.RENDER_SERVICE_ID }}
          api_key: ${{ secrets.DEPLOY_TO_RENDER_API }}
          wait_deploy: true

      # # Деплой на Render через API
      # - name: Deploy to Render
      #   if: success()
      #   env:
      #     RENDER_API_KEY: ${{ secrets.DEPLOY_TO_RENDER_API }}
      #     RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      #   run: |
      #     echo "Triggering deploy on Render..."           
      #     curl --request POST \
      #         --url https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys \
      #         --header 'accept: application/json' \
      #         --header 'authorization: Bearer $RENDER_API_KEY' \
      #         --header 'content-type: application/json' \
      #         --data '
      #     {
      #       "clearCache": "do_not_clear"
      #     }
      #     '